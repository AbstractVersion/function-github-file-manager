# GitHub File Manager Function

[![CI](https://github.com/kubecore/function-github-file-manager/actions/workflows/ci.yml/badge.svg)](https://github.com/kubecore/function-github-file-manager/actions/workflows/ci.yml)

A [Crossplane composition function][functions] that commits files directly to GitHub repositories using the GitHub API.

## Overview

This function provides a **dead simple** way to commit files to GitHub repositories from within Crossplane compositions. It:

- **Commits files directly** to GitHub using the GitHub API
- **Supports multiple files** in a single operation
- **Handles file creation and updates** automatically (idempotent)
- **Provides clear success/failure feedback**
- **Supports custom branches** and commit messages
- **No CRDs** - just commits files and reports status

## Features

- ✅ **Direct GitHub API integration** - no intermediate resources
- ✅ **Multiple files per operation** - commit related files together
- ✅ **Idempotent operations** - safe to run multiple times
- ✅ **Branch targeting** - commit to any branch
- ✅ **Custom commit messages** - per-file commit messages
- ✅ **Comprehensive error handling** - detailed error reporting
- ✅ **Fast execution** - typically completes in under 10 seconds

## Usage

### Basic Example

```yaml
apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: kubeapp-github-deployer
spec:
  compositeTypeRef:
    apiVersion: kubecore.io/v1alpha1
    kind: XKubeApp
  mode: Pipeline
  pipeline:
  - step: commit-files
    functionRef:
      name: function-github-file-manager
    input:
      apiVersion: github.fn.kubecore.io/v1beta1
      kind: Input
      spec:
        githubToken: "ghp_xxxxxxxxxxxxxxxxxxxx"
        files:
        - repository: "owner/repo"
          path: "apps/myapp/deployment.yaml"
          content: |
            apiVersion: apps/v1
            kind: Deployment
            metadata:
              name: myapp
            spec:
              replicas: 3
              # ... rest of deployment
          commitMessage: "Deploy myapp - generated by Crossplane"
          
        - repository: "owner/repo"
          path: "apps/myapp/service.yaml"
          content: |
            apiVersion: v1
            kind: Service
            metadata:
              name: myapp-svc
            spec:
              # ... service spec
          commitMessage: "Add service for myapp"
          branch: "main"
```

### Input Schema

The function accepts the following input structure:

```yaml
apiVersion: github.fn.kubecore.io/v1beta1
kind: Input
spec:
  # Authentication: Use EITHER githubToken OR githubApp (not both)
  
  # Option 1: Personal Access Token
  githubToken: string          # GitHub personal access token
  
  # Option 2: GitHub App (Recommended)
  githubApp:
    appId: string              # GitHub App ID
    installationId: string     # Installation ID for target repositories
    privateKey: string         # Private key in PEM format
  
  # Files to commit
  files:                       # Required: Array of files to commit
    - repository: string       # Required: GitHub repo in "owner/repo" format
      path: string             # Required: File path within repository
      content: string          # Required: File content
      commitMessage: string    # Required: Commit message for this file
      branch: string           # Optional: Target branch (default: "main")
```

### Output

The function returns results in the response context:

```yaml
context:
  github-file-manager:
    success: true              # Boolean: overall operation success
    filesProcessed: 2          # Number: files processed
    results:                   # Array: per-file results
      - path: "apps/myapp/deployment.yaml"
        status: "success"
        sha: "abc123..."
        githubUrl: "https://github.com/owner/repo/blob/main/apps/myapp/deployment.yaml"
    errors: []                 # Array: any error messages
```

## Authentication

The function supports two authentication methods: **GitHub App** (recommended for production) and **Personal Access Token** (for development).

### Option 1: GitHub App Authentication (Recommended)

GitHub Apps provide enhanced security, granular permissions, and better rate limits.

#### GitHub App Setup

1. **Create a GitHub App:**
   - Go to GitHub Settings → Developer settings → GitHub Apps → New GitHub App
   - Set homepage URL, webhook URL (can be placeholder)
   - Configure permissions:
     - Repository permissions:
       - **Contents**: Read & Write (to commit files)
       - **Metadata**: Read (to access repository info)
   - Install the app on target repositories

2. **Get Required Information:**
   - **App ID**: Found in app settings (e.g., `123456`)
   - **Installation ID**: From installation URL or API (e.g., `12345678`)
   - **Private Key**: Generate and download from app settings

#### Production Usage (Kubernetes Secrets)

```yaml
# Create secret with GitHub App credentials
apiVersion: v1
kind: Secret
metadata:
  name: github-app-credentials
type: Opaque
data:
  app-id: MTIzNDU2  # base64("123456")
  installation-id: MTIzNDU2Nzg=  # base64("12345678")
  private-key: LS0tLS1CRUdJTi... # base64(private-key-pem-content)

---
# Use in composition
spec:
  githubApp:
    appId: 
      secretRef:
        name: github-app-credentials
        key: app-id
    installationId:
      secretRef:
        name: github-app-credentials
        key: installation-id
    privateKey:
      secretRef:
        name: github-app-credentials
        key: private-key
```

#### Development Usage (Direct Values)

```yaml
spec:
  githubApp:
    appId: "123456"
    installationId: "12345678"
    privateKey: |
      -----BEGIN RSA PRIVATE KEY-----
      MIIEpAIBAAKCAQEA...
      ...your complete private key...
      -----END RSA PRIVATE KEY-----
```

### Option 2: Personal Access Token

Simpler setup for development and testing environments.

#### Development Usage

```yaml
spec:
  githubToken: "ghp_xxxxxxxxxxxxxxxxxxxx"
```

#### Production Usage (Kubernetes Secrets)

```yaml
# Create the secret
apiVersion: v1
kind: Secret
metadata:
  name: github-token
type: Opaque
data:
  token: <base64-encoded-token>

---
# Reference in composition
spec:
  githubToken: 
    secretRef:
      name: github-token
      key: token
```

### GitHub App vs Personal Access Token

| Feature | GitHub App | Personal Access Token |
|---------|------------|----------------------|
| **Security** | ✅ Granular permissions | ❌ Broad user permissions |
| **Rate Limits** | ✅ 5,000 requests/hour | ❌ 1,000 requests/hour |
| **Audit Trail** | ✅ App-specific logs | ❌ Mixed with user activity |
| **Token Rotation** | ✅ Automatic (1 hour) | ❌ Manual rotation required |
| **Organization Control** | ✅ Centrally managed | ❌ User-dependent |
| **Setup Complexity** | ❌ More complex | ✅ Simple |
| **Best For** | Production, teams | Development, testing |

## Examples

### Single File Commit (GitHub App)

```yaml
spec:
  githubApp:
    appId: "123456"
    installationId: "12345678"
    privateKey: |
      -----BEGIN RSA PRIVATE KEY-----
      MIIEpAIBAAKCAQEA...
      -----END RSA PRIVATE KEY-----
  files:
  - repository: "myorg/myrepo"
    path: "config/app.yaml"
    content: |
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: app-config
      data:
        env: production
    commitMessage: "Update app configuration"
```

### Single File Commit (Personal Token)

```yaml
spec:
  githubToken: "ghp_token"
  files:
  - repository: "myorg/myrepo"
    path: "config/app.yaml"
    content: |
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: app-config
      data:
        env: production
    commitMessage: "Update app configuration"
```

### Multiple Files with Different Branches

```yaml
spec:
  githubToken: "ghp_token"
  files:
  - repository: "myorg/myrepo"
    path: "prod/app.yaml"
    content: "production config..."
    commitMessage: "Update prod config"
    branch: "main"
    
  - repository: "myorg/myrepo"
    path: "dev/app.yaml"
    content: "development config..."
    commitMessage: "Update dev config"
    branch: "develop"
```

### Kubecore Integration

Perfect for GitOps workflows where Crossplane compositions generate Kubernetes manifests:

```yaml
- step: generate-manifests
  functionRef:
    name: function-github-file-manager
  input:
    apiVersion: github.fn.kubecore.io/v1beta1
    kind: Input
    spec:
      githubToken: "{{ .observed.composite.resource.spec.githubToken }}"
      files:
      - repository: "{{ .observed.composite.resource.spec.gitops.repository }}"
        path: "kubeapps/{{ .observed.composite.resource.metadata.name }}/base/resources.yaml"
        content: |
          # Generated Kubernetes manifests
          {{ include "deployment.yaml" . }}
          ---
          {{ include "service.yaml" . }}
        commitMessage: "Deploy {{ .observed.composite.resource.metadata.name }} via Crossplane"
        branch: "{{ .observed.composite.resource.spec.gitops.branch | default \"main\" }}"
```

## Installation

### From Package Registry

```bash
# Install the function
crossplane xpkg install function ghcr.io/kubecore/function-github-file-manager:latest

# Verify installation
kubectl get functions
```

### Development Setup

```bash
# Clone the repository
git clone https://github.com/kubecore/function-github-file-manager.git
cd function-github-file-manager

# Run locally for development
hatch run development

# In another terminal, test with examples
crossplane beta render example/xr.yaml example/composition.yaml example/functions.yaml
```

## Development

### Prerequisites

- [Python 3.11+](https://python.org)
- [Docker](https://www.docker.com)
- [Crossplane CLI](https://docs.crossplane.io/latest/cli)
- [Hatch](https://hatch.pypa.io/)

### Commands

```bash
# Run in development mode
hatch run development

# Run tests
hatch test

# Lint and format
hatch fmt

# Build runtime image
docker build . --tag=runtime

# Build function package
crossplane xpkg build -f package --embed-runtime-image=runtime
```

### Testing

The function includes comprehensive tests:

```bash
# Run all tests
hatch test

# Run specific test
hatch test tests/test_fn.py::TestGitHubFileManager::test_commit_new_file

# Run with coverage
hatch test --cov
```

## Error Handling

The function provides detailed error reporting:

### Common Errors

- **Missing GitHub token**: `GitHub token is required`
- **Invalid repository**: `Repository not found or access denied`
- **File validation**: `Missing required fields for file <path>`
- **API errors**: `Failed to commit <path>: 422 - Validation failed`

### Partial Failures

If some files succeed and others fail, the function will:
- Return `success: false` in the context
- Include both successful and failed results
- List all errors in the `errors` array
- Set function severity to `WARNING`

## Performance

- **Typical execution time**: 5-15 seconds for 2-5 files
- **Parallel processing**: Files are processed sequentially for API rate limiting
- **Memory usage**: Minimal - processes files one at a time
- **API limits**: Respects GitHub API rate limits

## Security

- **Token security**: Use Kubernetes secrets in production
- **Permissions**: Function requires repository write access
- **Validation**: All inputs are validated before GitHub API calls
- **Error handling**: Sensitive information is not logged

## Troubleshooting

### Function not found

```bash
# Check if function is installed
kubectl get functions

# Check function logs
kubectl logs -l app=function-github-file-manager
```

### GitHub API errors

#### For Personal Access Tokens

```bash
# Check token permissions
curl -H "Authorization: token $GITHUB_TOKEN" https://api.github.com/user

# Verify repository access  
curl -H "Authorization: token $GITHUB_TOKEN" https://api.github.com/repos/owner/repo
```

#### For GitHub Apps

```bash
# Check app installations (requires JWT token)
curl -H "Authorization: Bearer $JWT_TOKEN" https://api.github.com/app/installations

# Check installation repositories (requires installation token)
curl -H "Authorization: token $INSTALLATION_TOKEN" https://api.github.com/installation/repositories

# Verify app permissions on specific repo
curl -H "Authorization: token $INSTALLATION_TOKEN" https://api.github.com/repos/owner/repo
```

#### Common GitHub App Issues

1. **Invalid App ID or Installation ID**: Check your GitHub App settings
2. **Private Key Format**: Ensure PEM format with proper line breaks
3. **Clock Skew**: Function handles JWT timing automatically
4. **Permissions**: Verify app has Contents: Write permission
5. **Installation**: Ensure app is installed on target repositories

### Composition errors

```bash
# Check composition function step
kubectl describe composition <composition-name>

# Check XR status
kubectl describe xr <xr-name>
```

## Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add/update tests
5. Submit a pull request

## License

This project is licensed under the Apache License 2.0 - see the [LICENSE](LICENSE) file for details.

---

[functions]: https://docs.crossplane.io/latest/concepts/composition-functions
